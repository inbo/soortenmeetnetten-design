---
title: "GRTS sample for UTM 1 km x 1 km grid covering Belgium and Flanders"
author: "Toon Westra"
output:
  bookdown::html_document2:
    toc: TRUE
    toc_depth: 2
    toc_float:
      collapsed: FALSE
      smooth_scroll: FALSE
    number_sections: TRUE
date: "2023-05-03"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

library(tidyverse)
library(sf)
library(giscoR)
library(grtsdb)
library(terra)
library(leaflet)
library(conflicted)

conflicts_prefer(dplyr::filter())
```

# UTM 1 km grid covering Belgium

The UTM 1km grid consists of grid cells of 1 km x 1 km. The coordinate reference system (CRS) is ETRS89-LAEA Europe (epsg=3035). 
The xy-coordinates of the grid cells corners are always a multitude of 1000 meters.
Each grid cell has a unique code based on the coordinates of the lower left corner of the grid cell.
For example if the distance from the lower left corner of a grid cell to the origin is 3773000 meter East and 3043000 meter North, the code is `1kmE3773N3043`.

We create a UTM 1km grid covering Belgium as follows:

+ load sf object of Belgium using the `giscoR` package (Hernangomez, 2023)
+ transform it to `crs = 3035`
+ take a buffer of 25 km
+ derive the bounding box
+ round the bounding box to a multitude of 1000


```{r}

belgium <- gisco_get_nuts(nuts_level = 2, country = "Belgium", resolution = "01") %>%
  st_transform(crs = 3035)

flanders <- belgium %>%
  filter(NUTS_NAME %in% c("Prov. Antwerpen", 
                          "Prov. Oost-Vlaanderen", 
                          "Prov. West-Vlaanderen", 
                          "Prov. Vlaams-Brabant", 
                          "Prov. Limburg (BE)"))


belgium_buffer <- belgium  %>%
  st_buffer(dist = 25000)

bbox_belgium_buffer <- st_bbox(belgium_buffer)

xmin <- floor(bbox_belgium_buffer$xmin/1000)*1000
ymin <- floor(bbox_belgium_buffer$ymin/1000)*1000
xmax <- ceiling(bbox_belgium_buffer$xmax/1000)*1000
ymax <- ceiling(bbox_belgium_buffer$ymax/1000)*1000

xmin <- xmin - 1000
ymin <- ymin - 1000

x_res <- (xmax - xmin) / 1000
y_res <- (ymax - ymin) / 1000

```



# GRTS sample

We use the `grtsdb` package to create a grts sample with the bounding box created above and a cell size of 1 km.

```{r}

db <- connect_db()

bbox <- rbind(
  x = c(xmin, xmax),
  y = c(ymin, ymax)
)
  
cellsize <- 1000

add_level(bbox = bbox, cellsize = cellsize, grtsdb = db)
 
```
Next we convert the result to a raster, a point shapefile and a polygon shapefile and crop it to the extent of Belgium and Flanders.

```{r}
sample <- extract_sample(
  grtsdb = db, samplesize = 100000, bbox = bbox, cellsize = cellsize
)

sample_utm <- sample %>%
  mutate(cellcode = str_c("1kmE", (x1c - 500) / 1000, "N", (x2c - 500) / 1000))

belgium_buffer_vector_terra <- vect(belgium_buffer)

sample_utm_raster <- sample_utm %>%
  select(x = x1c, y = x2c, ranking) %>%
  rast(type = "xyz", crs = crs(belgium_buffer_vector_terra))

sample_utm_points_sf <- sample_utm %>%
  st_as_sf(coords = c("x1c", "x2c"), crs = 3035)

sample_utm_polygons_sf <- sample_utm %>%
  mutate(geom = str_c("POLYGON ((", x1c - 500, " ", x2c - 500, 
                                ",", x1c + 500, " ", x2c - 500,
                                ",", x1c + 500, " ", x2c + 500,
                                ",", x1c - 500, " ", x2c + 500,
                                ",", x1c - 500, " ", x2c - 500, "))")) %>%
  st_as_sf(wkt = "geom", crs = 3035)

```
```{r}

belgium_buffer_2000 <- belgium %>%
  group_by(CNTR_CODE) %>%
  summarise(level = "Belgium") %>%
  ungroup() %>%
  st_buffer(2000) %>%
  select(level)

grts_utm1_belgium_points <- sample_utm_points_sf %>%
  st_join(belgium_buffer_2000) %>%
  filter(!is.na(level))

grts_utm1_belgium_polygons <- sample_utm_polygons_sf %>%
  filter(cellcode %in% grts_utm1_belgium_points$cellcode)

grts_utm1_belgium_raster <- sample_utm_raster %>%
  crop(vect(belgium_buffer_2000)) %>%
  mask(vect(belgium_buffer_2000))

flanders_buffer_2000 <- flanders %>%
  group_by(CNTR_CODE) %>%
  summarise(level = "flanders") %>%
  ungroup() %>%
  st_buffer(2000) %>%
  select(level)

grts_utm1_flanders_points <- sample_utm_points_sf %>%
  st_join(flanders_buffer_2000) %>%
  filter(!is.na(level))

grts_utm1_flanders_polygons <- sample_utm_polygons_sf %>%
  filter(cellcode %in% grts_utm1_flanders_points$cellcode)

grts_utm1_flanders_raster <- sample_utm_raster %>%
  crop(vect(flanders_buffer_2000)) %>%
  mask(vect(flanders_buffer_2000))
  
```

# Check result

## Belgium

The map below show the 50 UTM1 cells with the lowest ranking in Belgium.

```{r}
grts_utm1_belgium_polygons_50 <- grts_utm1_belgium_polygons %>%
  slice_min(order_by = ranking, n = 50) %>%
  st_transform(4326)

grts_utm1_belgium_points_50 <- grts_utm1_belgium_points %>%
  slice_min(order_by = ranking, n = 50) %>%
  st_transform(4326)

grts_utm1_belgium_polygons_50 %>%
  leaflet() %>%
  addTiles() %>%
  addPolygons(label = ~ranking, labelOptions = labelOptions(noHide = TRUE)) %>%
  addCircleMarkers(data = grts_utm1_belgium_points_50, color = "red", label = ~ranking)
```

The raster of the grts is shown below. 

```{r}
grts_utm1_belgium_raster %>%
  plot()
```

## Flanders

The map below show the 50 UTM1 cells with the lowest ranking in Flanders.

```{r}
grts_utm1_flanders_polygons_50 <- grts_utm1_flanders_polygons %>%
  slice_min(order_by = ranking, n = 50) %>%
  st_transform(4326)

grts_utm1_flanders_points_50 <- grts_utm1_flanders_points %>%
  slice_min(order_by = ranking, n = 50) %>%
  st_transform(4326)

grts_utm1_flanders_polygons_50 %>%
  leaflet() %>%
  addTiles() %>%
  addPolygons(label = ~ranking, labelOptions = labelOptions(noHide = TRUE)) %>%
  addCircleMarkers(data = grts_utm1_flanders_points_50, color = "red", label = ~ranking)
```
The raster of the grts is shown below. 

```{r}
grts_utm1_flanders_raster %>%
  plot()
```


# Output

We write the resulting sf objects as a geopackage file and the raster object as a tif file.

We also save the sqlite file.

```{r}

if (!dir.exists("../output")) {
  
  dir.create("../output")
  
}

st_write(grts_utm1_belgium_points, dsn = "../output/grts_master_utm1_belgium.gpkg",
         layer = "cell_center",
         delete_layer = TRUE)

st_write(grts_utm1_belgium_polygons, dsn = "../output/grts_master_utm1_belgium.gpkg",
         layer = "cell_polygons",
         delete_layer = TRUE)

writeRaster(grts_utm1_belgium_raster, "../output/grts_master_utm1_belgium.tif", overwrite = TRUE)

st_write(grts_utm1_flanders_points, dsn = "../output/grts_master_utm1_flanders.gpkg",
         layer = "cell_center",
         delete_layer = TRUE)

st_write(grts_utm1_flanders_polygons, dsn = "../output/grts_master_utm1_flanders.gpkg",
         layer = "cell_polygons",
         delete_layer = TRUE)

writeRaster(grts_utm1_flanders_raster, "../output/grts_master_utm1_flanders.tif", overwrite = TRUE)

file.copy("grts.sqlite", "../output/grts_master_belgium.sqlite", overwrite = TRUE)
```

# Reference {-}

Hernangomez D (2023). giscoR: Download Map Data from GISCO API - Eurostat. <https://doi.org/10.5281/zenodo.4317946>, <https://ropengov.github.io/giscoR/>

